<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Corporate Site</title>
        <meta charset="utf-8" >
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="author" content="Hoang Minh Khue">
        <meta name="description" content="list view">
        <meta name="keywords" content="khue, list, vue, bootstrap">
        <!-- Bootstrap -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
            rel="stylesheet"
            crossorigin="anonymous">
        <script src="./vue.global.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/respond.js/1.3.0/respond.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    </head>
    <body>
        <div id="app">
            <div class="container">
                <h1>Lookup App: Unit Search Filter</h1>
                <div class="row">
                    <div class="form-group col-sm-12 col-md-4">
                        <label class="form-label" for="code">Code: </label>
                        <input class="form-control" id="code" type="text" v-model="code">
                    </div>
                    <div class="form-group col-sm-12 col-md-4">
                        <label class="form-label" for="desc">Description: </label>
                        <input class="form-control" id="desc" type="text" v-model="desc">
                    </div>
                    <div class="form-group col-sm-12 col-md-4">
                        <label class="form-label" for="type">Unit type: </label>
                        <div id="type" class="d-block">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="type" value="all" id="all" v-model="type">
                                <label class="form-check-label" for="all">
                                  All
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="type" value="Core" id="core" v-model="type">
                                <label class="form-check-label" for="core">
                                  Core
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="type" value="Software Development" id="sd" v-model="type">
                                <label class="form-check-label" for="sd">
                                    Software Development
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="type" value="Systems Analysis" id="sa" v-model="type">
                                <label class="form-check-label" for="sa">
                                    Systems Analysis
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <div @scroll="onScroll" class="table-responsive" style="max-height: 400px; overflow-y: scroll;">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th scope="col">
                                            Code
                                        </th>
                                        <th scope="col">
                                            Description
                                        </th>
                                        <th scope="col">
                                            Credit Points
                                        </th>
                                        <th scope="col">
                                            Type
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="c in this.filteredCourses">
                                        <td>
                                            {{c.code}}
                                        </td>
                                        <td>
                                            {{c.desc}}
                                        </td>
                                        <td>
                                            {{c.cp}}
                                        </td>
                                        <td>
                                            {{c.type}}
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Bootstrap javascript plug-ins -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
            crossorigin="anonymous"></script>
        <script src="./courses.js"></script>

        <script>
            const { createApp, computed, ref } = Vue
        
            createApp({
                setup() {
                    const pageNum = 0
                    const maxPage = 0
                    const code = ref("")
                    const desc = ref("")
                    const type = ref("all")
                    const filteredCourses = ref([])
                    return {
                        code,desc,type,filteredCourses
                    }
                },
                methods: {
                    filter() {
                        const pageSize = 10
                        var newCourses = []
                        courses.forEach(c => {
                            if((this.code === "" || c.code === this.code) && (this.desc === "" || c.desc.toLowerCase().includes(this.desc.toLowerCase())) && (this.type === "all" || c.type === this.type)) {
                                newCourses.push(c)
                            }
                        })
                        newCourses.sort((a, b) => {
                            if(a.desc > b.desc) {
                                return 1
                            } else if (a.desc < b.desc) {
                                return -1
                            } else {
                                return 0
                            }
                        })
                        return {
                            data: newCourses.splice(pageSize * this.pageNum, pageSize),
                            pageNum: this.pageNum,
                            maxPage: Math.ceil(newCourses.length * 1.0 / pageSize)
                        }
                    },

                    loadData() {
                        const getData = this.filter()
                        this.filteredCourses = [...this.filteredCourses, ...getData.data]
                        this.pageNum = getData.pageNum
                        this.maxPage = getData.maxPage
                    },

                    onScroll({ target: { scrollTop, clientHeight, scrollHeight }}) {
                        if (Math.ceil(scrollTop + clientHeight) >= scrollHeight && this.filteredCourses.length > 0 && this.pageNum < this.maxPage) {
                            this.pageNum += 1
                            this.loadData()
                        }
                    },

                    initData() {
                        this.filteredCourses = []
                        this.pageNum = 0
                        this.maxPage = 0
                        this.loadData()
                    }
                },
                watch: {
                    'code': {
                        handler() {
                            this.initData()
                        },
                        immediate: true
                    },
                    'desc': {
                        handler() {
                            this.initData()
                        },
                        immediate: true
                    },
                    'type': {
                        handler() {
                            this.initData()
                        },
                        immediate: true
                    },
                },
            }).mount('#app')
        </script>
</body>
</html>